<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Ventas â€” Vista privada</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:18px;background:#f7f7f8;color:#111;transition:background 0.3s,color 0.3s;}
    body.dark{background:#111;color:#eee;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input,button,select{padding:8px;border-radius:6px;border:1px solid #ccd0d6;background:white;color:#111}
    body.dark input, body.dark select, body.dark button{background:#222;border:1px solid #444;color:#eee;}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:white;border-radius:6px;overflow:hidden;transition:background 0.3s,color 0.3s;}
    body.dark table{background:#222;color:#eee;}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    body.dark th, body.dark td{border-color:#444;}
    th{background:#fafafa;cursor:pointer;user-select:none;transition:background 0.3s;}
    body.dark th{background:#333;}
    tr:hover{background:#fcfcfe}
    body.dark tr:hover{background:#333;}
    .muted{color:#666;font-size:13px;transition:color 0.3s;}
    body.dark .muted{color:#aaa;}
    #loading{color:#666;transition:color 0.3s;}
    body.dark #loading{color:#aaa;}
    .right{text-align:right}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;background:#eef}
    .export{margin-left:6px}
    .themeToggle{cursor:pointer;background:#000;color:#fff;padding:6px 10px;border-radius:6px;font-size:13px;}
    body.dark .themeToggle{background:#eee;color:#000;}
    @media (max-width:700px){th,td{font-size:13px;padding:6px}}
    a.whatsappBtn{display:inline-block;padding:6px 10px;background:#25D366;color:white;border-radius:6px;text-decoration:none;font-size:13px;}
    body.dark a.whatsappBtn{color:white;}
  </style>
</head>
<body>
  <header>
    <h1>Registro de ventas</h1>
    <div class="controls">
      <input id="search" placeholder="Buscar por cliente o producto" />
      <input id="filterID" placeholder="Filtrar por ID" />
      <input id="filterCelular" placeholder="Filtrar por celular" />
      <input id="from" type="date" title="Fecha desde" />
      <input id="to" type="date" title="Fecha hasta" />
      <select id="perPage">
        <option value="10">10 por pÃ¡gina</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <button id="refresh">Actualizar</button>
      <button id="export" class="export">Exportar CSV</button>
      <button id="themeToggle" class="themeToggle">Modo Oscuro</button>
    </div>
  </header>

  <div id="loading">Cargando datos...</div>
  <div id="summary" class="muted"></div>
  <table id="ventasTable" style="display:none">
    <thead>
      <tr>
        <th data-key="id">ID</th>
        <th data-key="fecha_hora">Fecha y hora</th>
        <th data-key="total" class="right">Total (ARS)</th>
        <th data-key="detalle_compra">Detalle</th>
        <th data-key="nombre_cliente">Cliente</th>
        <th data-key="celular_cliente">Celular</th>
        <th>Notificar</th>
        <th>Cliente</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <nav id="pager" style="margin-top:12px"></nav>

  <script>
    // ===== CONFIG =====
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdZ1Qsrzqopm4g4s0NZJK7AKm6plFVoKvpWdymZ-MOIAktQCWsa6Ki4te4UqJUfnfK/exec';
    const telefonoNegocio = '5492664212722';
    const nombreNegocio = "Ponete en Marcha";  // <<< AQUI TU NOMBRE
    // ==================

    let rawData=[], filtered=[], sortKey=null, sortDir=1, currentPage=1;
    let lastDataSnapshot = [];

    function formatDateTime(d){
      if(!d) return '';
      const pad=(n)=>n.toString().padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} - ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function mensajeWhatsApp(venta){
      return `Hola, se reporta un cambio en la venta ID ${venta.id}.
Cliente: ${venta.nombre_cliente}
Celular: ${venta.celular_cliente}
Total: ARS ${venta.total}
Detalle: ${venta.detalle_compra}
Negocio: ${nombreNegocio}
Por favor indica si se cancelÃ³ o modificÃ³ la compra.`;
    }

    function mensajeCliente(venta){
      return `Hola ${venta.nombre_cliente}, nos comunicamos de ${nombreNegocio}. Acabamos de recibir tu compra. Te avisaremos cuando tu pedido estÃ© listo.`;
    }

    async function fetchSheet(){
      const el = {
        loading: document.getElementById('loading'),
        table: document.getElementById('ventasTable')
      };
      el.loading.textContent='Cargando datos...';
      el.loading.style.display='block';
      el.table.style.display='none';

      try{
        const res = await fetch(APP_SCRIPT_URL);
        const json = await res.json();
        const rows = (json.rows||[]).map(normalizeRow);

        lastDataSnapshot = rows;
        rawData = rows;

        el.loading.style.display='none';
        el.table.style.display='';

        applyFilters();
      }catch(err){
        el.loading.textContent='Error cargando la hoja: '+err.message;
      }
    }

    function normalizeRow(r){
      const mapKey = k=>k?k.toString().toLowerCase().replace(/\s+/g,'_'):'';  
      const norm = {};
      for(const k in r) norm[mapKey(k)] = r[k];

      const out = {};
      out.id = norm.id||norm['#']||'';
      out.fecha_hora = norm.fecha_hora||norm.fecha||'';
      out.total = parseFloat((norm.total||'0').toString().replace(",","."));
      out.detalle_compra = norm.detalle_compra||norm.detalle||'';
      out.nombre_cliente = norm.nombre_cliente||norm.cliente||'';
      out.celular_cliente = norm.celular_cliente||norm.celular||'';
      out._date = new Date(out.fecha_hora);
      return out;
    }

    function renderTable(data){
      const tbody=document.querySelector('#ventasTable tbody');
      tbody.innerHTML='';

      const start=(currentPage-1)*10;
      const pageData=data.slice(start,start+10);

      for(const row of pageData){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${row.id}</td>
          <td>${formatDateTime(row._date)}</td>
          <td class="right">${row.total.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
          <td>${row.detalle_compra}</td>
          <td>${row.nombre_cliente}</td>
          <td>${row.celular_cliente}</td>

          <td>
            <a href="https://wa.me/${telefonoNegocio}?text=${encodeURIComponent(mensajeWhatsApp(row))}" 
               target="_blank" class="whatsappBtn">ðŸ“© Notificar a soporte</a>
          </td>

          <td>
            <a href="https://wa.me/549${String(row.celular_cliente).replace(/\D/g,'')}?text=${encodeURIComponent(mensajeCliente(row))}" 
               target="_blank" class="whatsappBtn">ðŸ’¬ Comunicarse con cliente</a>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function applyFilters(){
      renderTable(rawData);
    }

    fetchSheet();
    setInterval(fetchSheet,30000);

  </script>
</body>
</html>
